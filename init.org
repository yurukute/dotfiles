#+TITLE: Emacs Configuration
* Load package.el and MELPA repository
#+begin_src emacs-lisp
  (require 'package)
  (add-to-list 'package-archives '("melpa" . "http://melpa.org/packages/") t)
  (package-initialize)
#+end_src

* Load use-package
#+begin_src emacs-lisp
  (unless (package-installed-p 'use-package)
    (package-refresh-contents)
    (package-install 'use-package))
  (eval-when-compile
    (require 'use-package))

  (setq use-package-always-ensure t)
#+end_src

* User's setting
** Coding system
#+begin_src emacs-lisp
  (prefer-coding-system       'utf-8)
  (set-default-coding-systems 'utf-8)
  (set-terminal-coding-system 'utf-8)
  (set-keyboard-coding-system 'utf-8)
  (setq default-buffer-file-coding-system 'utf-8)
#+end_src

** User settings
#+begin_src emacs-lisp
  (setq column-number-mode t
        cua-rectangle-mark-key [C-M-return]
        fill-column 80
        inhibit-startup-screen t
        initial-major-mode 'fundamental-mode
        ;;initial-scratch-message (shell-command-to-string "")
        line-number-mode nil
        make-backup-files nil
        mode-require-final-newline nil
        mouse-wheel-follow-mouse 't
        mouse-wheel-progressive-speed t
        mouse-wheel-scroll-amount '(1 ((shift) . 1) ((control)))
        recentf-auto-cleanup 'never)

  (cua-mode t)
  ;;(desktop-save-mode 1)
  (recentf-mode t)
#+end_src

** User interface
#+begin_src emacs-lisp
  (electric-pair-mode 1)
  (menu-bar-mode -1)
  (scroll-bar-mode -1)
  (show-paren-mode 1)
  (tool-bar-mode -1)

  (add-hook 'prog-mode-hook 'display-fill-column-indicator-mode)
  (add-hook 'prog-mode-hook 'display-line-numbers-mode)
  (global-visual-line-mode t)

  (push '("Droid Sans Mono" "Consolas") face-font-family-alternatives)
  (push '("Monospace" "Consolas") face-font-family-alternatives)  
  (push '("Noto Color Emoji" "Segoe UI Emoji") face-font-family-alternatives)
  (internal-set-alternative-font-family-alist face-font-family-alternatives)

  (set-fontset-font t 'symbol "Noto Color Emoji")
  (set-frame-font "Monospace 11" nil t)
  (set-frame-parameter (selected-frame) 'alpha ' 85)
#+end_src

** User keybindings
#+begin_src emacs-lisp
  (global-set-key [mouse-8] 'previous-buffer)
  (global-set-key [mouse-9] 'next-buffer)
  (global-set-key (kbd "C-x k") 'kill-current-buffer)
  (global-set-key (kbd "C-k") 'eshell)

  ;; Windmove
  (global-set-key (kbd "C-c <left>")  'windmove-left)
  (global-set-key (kbd "C-c <right>") 'windmove-right)
  (global-set-key (kbd "C-c <up>")    'windmove-up)
  (global-set-key (kbd "C-c <down>")  'windmove-down)
#+end_src

** Indenting C/C++
#+begin_src emacs-lisp
  (setq-default tab-width 4
                c-basic-offset tab-width
                indent-tabs-mode nil)

  (defun struct-indent (langelem)
    (let ((inclass (assoc 'inclass c-syntactic-context)))
      (save-excursion
        (goto-char (c-langelem-pos inclass))
        (if (or (looking-at "struct")
                (looking-at "typedef struct"))
            '2
          '4))))

  (c-set-offset 'access-label -2)
  (c-set-offset 'inclass 'struct-indent)
#+end_src

** Disable electric-indent-mode in some modes
#+begin_src emacs-lisp
  (defun disable-electric-indent-mode ()
    "Disable `electric-indent-mode` in current major mode"
    (set (make-local-variable 'electric-indent-mode) nil))

  (add-hook 'text-mode-hook 'disable-electric-indent-mode)
#+end_src

** Sort words
#+begin_src emacs-lisp
  (defun sort-words (reverse beg end)
    "Sort words in region alphabetically, in REVERSE if negative.
  Prefixed with negative \\[universal-argument], sorts in reverse.
  The variable `sort-fold-case' determines whether alphabetic case affects the sort order.

  See `sort-regexp-fields'."
    (interactive "*P\nr")
    (sort-regexp-fields reverse "\\w+" "\\&" beg end))
#+end_src

* Interface packages
** Monokai theme
#+begin_src emacs-lisp
  (use-package monokai-theme
    :config (load-theme 'monokai t))
#+end_src

** Nyancat the cutest
#+begin_src emacs-lisp
  (use-package nyan-mode
    :custom
    (nyan-animation-frame-interval 0.07)
    (nyan-wavy-trail t)
    (nyan-animate-nyancat t)
    :config
    (nyan-mode))
#+end_src

** Helm
#+begin_src emacs-lisp
  (use-package helm
    :bind (([remap find-file] . helm-find-files)
           ([remap execute-extended-command] . helm-M-x)
           ([remap switch-to-buffer] . helm-mini))
    :custom (helm-ff-file-name-history-use-recentf t)
    :config (helm-mode))
  (use-package helm-xref)
#+end_src

* Development packages
** LSP - Language Server Protocol
#+begin_src emacs-lisp
  (use-package lsp-mode
    :hook 
    (c-mode . (lambda() (unless (string= major-mode "arduino-mode") (lsp))))
    (c++-mode go-mode java-mode python-mode rust-mode sql-mode web-mode)
    :bind
    ("<C-return>" . lsp-sql-execute-paragraph)
    ("<C-f7>" . lsp-sql-execute-query)
    :config
    (define-key lsp-mode-map (kbd "C-c l") lsp-command-map)
    (setf (alist-get 'web-mode lsp--formatting-indent-alist)
          'web-mode-code-indent-offset)
    :custom     
    ;; (lsp-pylsp-plugins-flake8-enabled nil)
    (lsp-pylsp-plugins-pydocstyle-enabled nil)
    (lsp-sqls-connections
     '(((driver . "postgresql") (dataSourceName . "host=localhost user=dung dbname=exampleDB")))))

  (use-package lsp-ui
    :hook (lsp-mode . lsp-ui-mode)
    :custom
    (lsp-ui-doc-position 'at-point)
    (lsp-ui-doc-show-with-cursor t))

  (use-package lsp-java
    :custom (lsp-java-format-on-type-enabled nil))

  (use-package lsp-treemacs
    :custom (treemacs-width 25)
    :bind ((  [f8] . treemacs-select-window)
           ([S-f8] . treemacs)))
#+end_src

** DAP - Debug Adapter Protocol
#+begin_src emacs-lisp
  (use-package dap-mode
    :custom
    (dap-auto-show-output nil)
    (dap-debug-restart-keep-session nil)
    (dap-inhibit-io nil)
    (dap-internal-terminal 'dap-internal-terminal-vterm)
    :bind ((   [f5] . dap-debug)
           ( [S-f5] . dap-disconnect)
           (   [f7] . dap-ui-expressions-add)
           (   [f9] . dap-breakpoint-toggle)
           ( [S-f9] . dap-breakpoint-delete-all)
           (  [f10] . dap-next)
           (  [f11] . dap-step-in)
           ([S-f11] . dap-step-out))
    :commands dap-debug
    :config
    ;; C/C++
    (require 'dap-cpptools)
    (dap-cpptools-setup)
    ;; Python
    (require 'dap-python)
    ;; Templates
    (add-to-list 'dap-debug-template-configurations
                 '("cpptools::QuickDebug"
                   :type "cppdbg"
                   :request "launch"
                   :name "Quick debug"
                   :MIMode "gdb"
                   :program "${fileDirname}../build/${fileBasenameNoExtension}"
                   :stopatentry "false"
                   :dap-compilation "/usr/bin/make"
                   :dap-compilation-dir "${fileDirname}"
                   :cwd "${workspaceFolder}")))
#+end_src

** Company - Text completion
#+begin_src emacs-lisp
  (use-package company
    :config (global-company-mode t)
    :bind ("C-'" . company-files))

  (use-package company-arduino)
  (use-package company-c-headers
    :config
    (add-to-list 'company-backends 'company-c-headers)
    (add-to-list 'company-c-headers-path-system "/usr/include/c++/11.1.0/")
    (add-to-list 'company-c-headers-path-user "~/C++/"))

  (use-package company-go)
  (use-package company-jedi
    :config (add-to-list 'company-backends 'company-jedi)
    :custom (jedi:complete-on-dot t))

  (use-package company-lua)
  (use-package yasnippet  
    :config (yas-global-mode t))
#+end_src

** Flycheck - Realtime error checking
#+begin_src emacs-lisp
  (use-package flycheck
    :config
    (global-flycheck-mode)
    (require 'flycheck-arduino)
    :hook (arduino-mode . flycheck-arduino-setup)
    :custom (flycheck-disabled-checkers '(emacs-lisp-checkdoc)))

  (use-package flycheck-rust)
  (use-package flymake-lua)
#+end_src

** Format code
#+begin_src emacs-lisp
  (use-package format-all
    :bind ("M-s f" . format-all-buffer)
    :hook 
    (prog-mode . format-all-mode)
    (before-save . format-all-buffer))
#+end_src

** Highlight hex color
#+begin_src emacs-lisp
  (use-package rainbow-mode
    :hook (web-mode lua-mode))
#+end_src

** Lua
#+begin_src emacs-lisp
  (use-package lua-mode
    :custom (lua-indent-level 2)
    :hook (disable-electric-indent-mode))
#+end_src

** Cargo for Rust
#+begin_src emacs-lisp
  (use-package rust-mode)
  (use-package cargo
    :hook (rust-mode . cargo-minor-mode))
#+end_src

** Python
#+begin_src emacs-lisp
  (use-package python-mode
    :hook (python-mode . (lambda ()
                           (setq-local require-final-newline t))))
#+end_src

** Web development
#+begin_src emacs-lisp
  (use-package web-mode
    :mode ("\\.html?\\'" "\\.css\\'" "\\.js\\'")
    :custom
    (web-mode-code-indent-offset 2)
    (web-mode-css-indent-offset 2)
    (web-mode-enable-auto-indentation nil)
    (web-mode-enable-auto-quoting nil)
    (web-mode-enable-current-column-highlight t)
    (web-mode-enable-current-element-highlight t)
    (web-mode-enable-element-content-fontification t)
    (web-mode-enable-html-entities-fontification t)
    (web-mode-markup-indent-offset 2))

  (use-package impatient-mode
    :hook 
    (web-mode)
    (impatient-mode . httpd-start))

  (use-package emmet-mode
    :bind ("C-x j" . emmet-expand-yas)
    :hook (web-mode))

  (use-package go-mode)
#+end_src

* Other packages
** Projectile
#+begin_src emacs-lisp
  (use-package projectile
    :bind (:map projectile-mode-map
                ("C-c p" . projectile-command-map))
    :config (projectile-mode))
#+end_src

** Which-key
#+begin_src emacs-lisp
  (use-package which-key
    :config (which-key-mode))
#+end_src

** SQL indent minor mode
#+begin_src emacs-lisp
  (use-package markdown-mode
    :custom
    (markdown-enable-math t)
    (markdown-fontify-code-blocks-natively t))
#+end_src

** Vterm
#+begin_src emacs-lisp
  (use-package vterm
    :bind (("C-k" . vterm)
           ("C-y" . vterm-yank)))
#+end_src

** Open file in external program
#+begin_src emacs-lisp
  (use-package openwith
    :custom
    (openwith-associations '(("\\.pdf\\'" "microsoft-edge-dev" (file))
                             ("\\.mp3\\'" "sox" (file))
                             ("\\.\\(?:mpe?g\\|avi\\|wmv\\)\\'" "mpv" (file))))
    :config (openwith-mode t))
#+end_src

** Control popup window
#+begin_src emacs-lisp
  (use-package popwin
    :config
    (push '("*vterm*" :stick t) popwin:special-display-config)
    (push '("^\\*\\(.*shell\\|Quick debug.*\\|Warnings\\|Breakpoints\\)\\*$" 
            :stick t :regexp non-nil)
          popwin:special-display-config)
    (push '("*sqls results*" :stick t :noselect non-nil) popwin:special-display-config)
    (popwin-mode 1))
#+end_src

** Discord rich presence
#+begin_src emacs-lisp
  (use-package elcord
    :config (elcord-mode))
#+end_src

* BEAUTIFYING ORG-MODE
** Keybindings
#+begin_src  emacs-lisp
  (global-set-key (kbd "C-c l") #'org-store-link)
  (global-set-key (kbd "C-c a") #'org-agenda-list)
  (global-set-key (kbd "C-c c") #'org-capture)
  (global-set-key (kbd "C-c f") #'org-toggle-latex-fragment)
  (global-set-key (kbd "C-c e") #'org-edit-latex-fragment)
  (global-set-key (kbd "C-c p") #'org-preview-latex-fragment)
#+end_src

** Custom
#+begin_src emacs-lisp
  (setq org-agenda-files '("~")     
        org-ellipsis " ⤵"
        org-fontify-done-headline t
        org-format-latex-options
        '(:foreground default :background default :scale 1.5 :html-foreground "Black" :html-background "Transparent" :html-scale 1.0 :matchers ("begin" "$1" "$" "$$" "\\(" "\\["))
        org-hide-emphasis-markers t
        org-hide-leading-stars t       
        org-startup-with-latex-preview t
        org-src-tab-acts-natively t
        org-support-shift-select t
        org-todo-keywords '((sequence "☛ TODO(t)" "|" "✔ DONE(d)")
                            (sequence "⚑ WAITING(w)" "|")
                            (sequence "|" "✘ CANCELED(c)")))
  (require 'org-tempo)    
  (setq-default prettify-symbols-alist '(("#+begin_src" . "```")
                                         ("#+end_src" . "```")
                                         (">=" . "≥")
                                         ("<=" . "≤")
                                         ("=>" . "⇨")))
  (setq prettify-symbols-unprettify-at-point 'right-edge)
#+end_src

** Hook
#+begin_src emacs-lisp
  (add-hook 'org-mode-hook (lambda()
                             (disable-electric-indent-mode)
                             (visual-line-mode)
                             (variable-pitch-mode)
                             (prettify-symbols-mode)))
#+end_src

** Unordered lists
#+begin_src emacs-lisp
  (font-lock-add-keywords 
   'org-mode
   '(("^ *\\([-]\\) " (0 (prog1 () (compose-region (match-beginning 1) (match-end 1) "•"))))))
  (font-lock-add-keywords 
   'org-mode
   '(("^ *\\([+]\\) " (0 (prog1 () (compose-region (match-beginning 1) (match-end 1) "◦"))))))
#+end_src

** Org-bullets
#+begin_src emacs-lisp
  (use-package org-bullets
    :hook (org-mode . org-bullets-mode))
#+end_src

** Org-fancy-priorities
#+begin_src emacs-lisp
  (use-package org-fancy-priorities
    :hook (org-mode . org-fancy-priorities-mode)
    :custom (org-fancy-priorities-list '("⚡" "⬆" "⬇" "☕")))
#+end_src

** Org faces 
#+begin_src emacs-lisp  
  (dolist (face '(org-block
                  org-document-info-keyword
                  org-property-value
                  org-special-keyword
                  org-verbatim))
    (set-face-attribute face nil :inherit 'fixed-pitch :height 1.0))
  (set-face-attribute 'org-table nil :inherit 'fixed-pitch :height 1.0 :foreground "#82D7FF" :family "Droid Sans Mono")
#+end_src

